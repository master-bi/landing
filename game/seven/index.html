<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>電子百家樂（自動 20 秒一局 + 翻牌動畫）</title>
<style>
  :root{
    --bg:#0f1115;
    --panel:#141a24;
    --panel2:#0d1219;
    --muted:#94a3b8;
    --txt:#e6edf3;
    --red:#ef4444;
    --blue:#60a5fa;
    --gold:#f59e0b;
    --green:#34d399;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial, "Noto Sans TC","Microsoft JhengHei",sans-serif;
    color:var(--txt);
    background: radial-gradient(60% 80% at 50% 15%, #141b28 0%, #0b0f15 100%);
  }
  .layout{
    display:grid;
    grid-template-columns: 320px 1fr 360px;
    grid-template-rows: auto 1fr auto;
    gap:12px;
    height:100%;
    padding:12px;
  }
  .card{
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
    border:1px solid #1f2734;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  .topbar{
    grid-column:1 / -1;
    display:flex;align-items:center;gap:12px;
    padding:10px 14px;
  }
  .badge{padding:6px 10px;border-radius:999px;background:#0c1220;border:1px solid #1f2734;color:#9cc2ff;font-weight:700}
  .timer{margin-left:auto;padding:6px 12px;border-radius:10px;border:1px solid #1f2734;background:#0c1220;font-weight:900;letter-spacing:1px}
  .left,.right{padding:12px}

  .title{font-weight:900;letter-spacing:2px;color:#9cc2ff}
  .muted{color:var(--muted);font-size:13px}

  /* 中央桌面 */
  .table{
    position:relative;
    overflow:hidden;
    display:grid;
    grid-template-rows: 92px 1fr auto;
  }
  .table-bg{
    position:absolute;inset:0;
    background:
      radial-gradient(50% 40% at 50% 20%, rgba(58,93,163,.25) 0%, rgba(0,0,0,0) 60%),
      conic-gradient(from 210deg at 50% 130%, #142237, #0c1220, #0c1220, #142237);
    pointer-events:none;
  }
  .dealer{
    grid-row:1; position:relative; display:flex;align-items:center;justify-content:center;
    padding-top:10px;
  }
  /* 卡通擬真人荷官（簡易SVG + 動畫） */
  .dealer .avatar{
    width:120px;height:82px;position:relative;filter:drop-shadow(0 8px 16px rgba(0,0,0,.35));
    animation: breathe 3s ease-in-out infinite;
  }
  @keyframes breathe { 0%,100%{transform:translateY(0)} 50%{transform:translateY(2px)} }

  .board{
    grid-row:2; position:relative; display:grid;
    grid-template-columns: 1fr 1fr; gap:18px; padding:18px;
  }
  .hand{
    border:1px solid #1f2734;border-radius:14px;padding:12px;min-height:160px;
    background:linear-gradient(180deg,#111827 0%,#0c121a 100%);
  }
  .hand.player .name{color:#93c5fd}
  .hand.banker .name{color:#fecaca}
  .name{font-weight:900;letter-spacing:3px;margin-bottom:8px}
  .pile{
    display:flex;gap:10px;align-items:center;flex-wrap:nowrap;min-height:118px;
  }

  /* 撲克牌（3D 翻牌） */
  .card3d{
    width:78px;height:112px;perspective:600px;position:relative;
  }
  .card3d .inner{
    position:absolute;inset:0;transform-style:preserve-3d;
    transition: transform .35s ease;
  }
  .card3d.flip .inner{ transform: rotateY(180deg); }

  .face,.back{
    position:absolute;inset:0;border-radius:10px;backface-visibility:hidden;
    border:1px solid #1f2734;display:flex;align-items:center;justify-content:center;
    font-weight:900;
  }
  .face{
    transform: rotateY(180deg);
    background:#ffffff;color:#0b1220;
    font-size:28px; box-shadow: inset 0 0 0 6px rgba(0,0,0,.06);
  }
  .face.red{ color:#c81e1e }
  .back{
    background: repeating-linear-gradient(45deg,#1d293b,#1d293b 6px,#223049 6px,#223049 12px);
  }

  .result-badge{
    grid-row:3; text-align:center; padding:10px 12px; font-weight:900; letter-spacing:2px;
    color:#e5f2ff;
  }

  /* 下注墊 */
  .betpads{
    position:absolute;inset:auto 18px 18px 18px; display:grid;grid-template-columns: repeat(3,1fr); gap:10px;
  }
  .pad{
    text-align:center;padding:12px;border-radius:14px;border:2px solid transparent;cursor:pointer;user-select:none;
    background:#0c1220bd; backdrop-filter: blur(3px);
  }
  .pad.player{ border-color:rgba(96,165,250,.45) }
  .pad.banker{ border-color:rgba(239,68,68,.45) }
  .pad.tie{    border-color:rgba(245,158,11,.45) }
  .pad:hover{ filter:brightness(1.1) }
  .pad .t{font-weight:900;letter-spacing:2px}
  .pad.player .t{color:#93c5fd}
  .pad.banker .t{color:#fecaca}
  .pad.tie .t{color:#fcd34d}
  .pad .amt{margin-top:6px;color:#cbd5e1;font-weight:800}
  .locked .pad{ pointer-events:none; opacity:.6 }

  /* 路圖 */
  .road{display:grid;grid-template-columns: repeat(12,1fr);gap:6px;margin-top:8px}
  .dot{width:18px;height:18px;border-radius:999px;margin:auto;border:2px solid transparent}
  .dot.player{background:#3b82f6;border-color:#93c5fd}
  .dot.banker{background:#ef4444;border-color:#fecaca}
  .dot.tie{background:#f59e0b;border-color:#fde68a}

  .chipbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:8px 12px;border-radius:999px;background:#1f2937;border:1px solid #374151;color:#e5e7eb;font-weight:900;cursor:pointer}
  .chip.active{outline:2px solid #93c5fd}
  .chip.disabled{opacity:.35;pointer-events:none}

  .balance{font-size:24px;font-weight:900}
  .msg{color:#fca5a5;font-size:13px;min-height:20px;margin-top:6px}
  .good{color:#86efac}
</style>
</head>
<body>
  <div class="layout">
    <div class="topbar card">
      <div class="badge">電子百家樂</div>
      <div class="badge">20 秒/局（下注 15 + 開牌 5）</div>
      <div class="badge">限紅 100 – 100,000</div>
      <div id="phase" class="badge">等待中</div>
      <div id="timer" class="timer">20</div>
    </div>

    <div class="left card">
      <div class="title">歷史路圖</div>
      <div id="road" class="road"></div>
    </div>

    <div id="table" class="table card">
      <div class="table-bg"></div>

      <!-- 擬真人荷官（卡通風格） -->
      <div class="dealer">
        <svg class="avatar" viewBox="0 0 160 110" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <!-- 頭髮 -->
          <ellipse cx="80" cy="36" rx="30" ry="22" fill="#1c2436"/>
          <!-- 臉 -->
          <ellipse cx="80" cy="44" rx="22" ry="18" fill="#ffd8c2"/>
          <!-- 眼睛 -->
          <circle cx="70" cy="44" r="4" fill="#0b1220"/>
          <circle cx="90" cy="44" r="4" fill="#0b1220"/>
          <!-- 微笑 -->
          <path d="M70 56 C80 62 90 62 100 56" stroke="#e76f51" stroke-width="3" fill="none" stroke-linecap="round"/>
          <!-- 衣領 -->
          <path d="M60 82 Q80 70 100 82 L94 98 L66 98 Z" fill="#ffffff" stroke="#d1d5db" />
          <!-- 紅領結 -->
          <path d="M80 80 l-16 6 l16 6 l16-6 l-16-6z" fill="#dc2626"/>
          <circle cx="80" cy="86" r="5" fill="#b91c1c"/>
          <!-- 手臂（動畫輕微擺動） -->
          <g style="transform-origin:120px 90px; animation:hand 2.5s ease-in-out infinite;">
            <rect x="110" y="84" width="24" height="10" rx="5" fill="#ffd8c2"/>
          </g>
          <style>@keyframes hand{50%{transform:rotate(5deg)}} </style>
        </svg>
      </div>

      <!-- 牌區 -->
      <div class="board">
        <div class="hand player">
          <div class="name">PLAYER（閒）</div>
          <div id="pile-player" class="pile"></div>
        </div>
        <div class="hand banker">
          <div class="name">BANKER（莊）</div>
          <div id="pile-banker" class="pile"></div>
        </div>
      </div>

      <div id="result" class="result-badge muted">等待中…</div>

      <!-- 下注墊 -->
      <div id="pads" class="betpads">
        <div class="pad player" data-type="player">
          <div class="t">閒 1:1</div>
          <div id="amt-player" class="amt">$0</div>
        </div>
        <div class="pad tie" data-type="tie">
          <div class="t">和 8:1</div>
          <div id="amt-tie" class="amt">$0</div>
        </div>
        <div class="pad banker" data-type="banker">
          <div class="t">莊 0.95</div>
          <div id="amt-banker" class="amt">$0</div>
        </div>
      </div>
    </div>

    <div class="right card">
      <div class="title">資金</div>
      <div id="balance" class="balance">$100,000</div>
      <div class="title" style="margin-top:10px">籌碼</div>
      <div id="chipbar" class="chipbar"></div>
      <div id="msg" class="msg"></div>
      <div class="title" style="margin-top:10px">本局投注</div>
      <div id="betsum">$0</div>
    </div>

    <div class="card" style="grid-column:1/-1;padding:10px 12px">
      <span class="muted">規則：莊贏 0.95、閒贏 1、和局 8。和局時莊/閒押注退回。採用標準百家樂第三張牌規則。</span>
    </div>
  </div>

<script>
/* ---------- 遊戲參數 ---------- */
const INITIAL_BAL = 100000;
const MIN_BET = 100;
const MAX_BET = 100000;             // 已改為十萬
const CHIPS   = [100,500,1000,5000,10000,50000,100000];

const ROUND_SEC = 20;               // 每局 20 秒
const BETTING_SEC = 15;             // 下注 15 秒
const REVEAL_SEC = 5;               // 開牌 5 秒
const PAY = { banker:0.95, player:1.0, tie:8.0 };

let balance = INITIAL_BAL;
let selectChip = CHIPS[0];
let sec = ROUND_SEC;
let phase = 'bet';                  // bet | reveal
let timerId = null;

const bets = { banker:0, player:0, tie:0 };
const history = [];                 // 'banker' | 'player' | 'tie'

/* ---------- DOM ---------- */
const elTimer = document.getElementById('timer');
const elPhase = document.getElementById('phase');
const elBalance = document.getElementById('balance');
const elMsg = document.getElementById('msg');
const elBetSum = document.getElementById('betsum');
const elChipbar = document.getElementById('chipbar');
const elRoad = document.getElementById('road');
const pads = document.getElementById('pads');
const tableEl = document.getElementById('table');
const pileP = document.getElementById('pile-player');
const pileB = document.getElementById('pile-banker');
const elResult = document.getElementById('result');

const fmt = n => '$' + n.toLocaleString();

/* ---------- UI 更新 ---------- */
function setMsg(t='', ok=false){ elMsg.textContent = t; elMsg.className='msg' + (ok?' good':''); }
function setPhase(p){ phase=p; elPhase.textContent = (p==='bet'?'下注中':'開牌中'); tableEl.classList.toggle('locked', p!=='bet'); refreshChips(); }
function updateBalance(){ elBalance.textContent = fmt(balance); }
function updateBets(){
  document.getElementById('amt-banker').textContent = fmt(bets.banker);
  document.getElementById('amt-player').textContent = fmt(bets.player);
  document.getElementById('amt-tie').textContent    = fmt(bets.tie);
  elBetSum.textContent = fmt(bets.banker+bets.player+bets.tie);
}
function clearBets(){ bets.banker=bets.player=bets.tie=0; updateBets(); }
function refreshChips(){
  [...elChipbar.children].forEach(b=>{
    const v = Number(b.dataset.val);
    b.classList.toggle('active', v===selectChip);
    b.classList.toggle('disabled', phase==='bet' && (v<MIN_BET || v>MAX_BET));
  });
}

/* ---------- 路圖 ---------- */
function renderRoad(){
  elRoad.innerHTML = '';
  const last = history.slice(-60);
  last.forEach(r=>{
    const d=document.createElement('div'); d.className='dot ' + r; elRoad.appendChild(d);
  });
  const left = 12*5 - last.length;
  for(let i=0;i<left;i++){ elRoad.appendChild(document.createElement('div')); }
}

/* ---------- 籌碼 ---------- */
function buildChips(){
  elChipbar.innerHTML='';
  CHIPS.forEach(v=>{
    const b=document.createElement('button');
    b.className='chip'; b.textContent = fmt(v); b.dataset.val=v;
    elChipbar.appendChild(b);
  });
  refreshChips();
}
elChipbar.addEventListener('click',(e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  selectChip = Number(btn.dataset.val); refreshChips();
});

/* ---------- 下注 ---------- */
pads.addEventListener('click', e=>{
  const pad = e.target.closest('.pad'); if(!pad || phase!=='bet') return;
  const type = pad.dataset.type;
  const v = selectChip;
  if(v<MIN_BET || v>MAX_BET) { setMsg(`限紅 ${fmt(MIN_BET)} – ${fmt(MAX_BET)}`); return; }
  if(balance < v){ setMsg('餘額不足'); return; }
  balance -= v; bets[type]+=v; updateBalance(); updateBets(); setMsg('');
});

/* ---------- 撲克牌邏輯（標準百家樂） ---------- */
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const SUITS=['♠','♥','♦','♣']; // 只用來上色

function cardValue(rank){
  if(rank==='A') return 1;
  if(rank==='10'||rank==='J'||rank==='Q'||rank==='K') return 0;
  return Number(rank);
}
function mod10(n){ return ((n%10)+10)%10; }

function buildDeck(){
  const d=[];
  for(const s of SUITS) for(const r of RANKS) d.push({r,s});
  // 洗牌
  for(let i=d.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]];
  }
  return d;
}

/* ---------- 發牌 & 動畫 ---------- */
function createCardEl(card){
  const el=document.createElement('div');
  el.className='card3d';
  el.innerHTML=`
    <div class="inner">
      <div class="face ${ (card.s==='♥'||card.s==='♦') ? 'red':'' }">${card.r}${card.s}</div>
      <div class="back"></div>
    </div>`;
  return el;
}
function flip(el, delay=0){
  return new Promise(res=>{
    setTimeout(()=>{ el.classList.add('flip'); setTimeout(res, 340); }, delay);
  });
}
function resetPiles(){ pileP.innerHTML=''; pileB.innerHTML=''; elResult.textContent='開牌中…'; }

/* 百家樂第三張牌規則 */
function drawBaccarat(deck){
  const p=[], b=[];
  p.push(deck.pop(), deck.pop());
  b.push(deck.pop(), deck.pop());

  const pv = mod10(cardValue(p[0].r)+cardValue(p[1].r));
  const bv = mod10(cardValue(b[0].r)+cardValue(b[1].r));

  // Natural
  if(pv>=8 || bv>=8){
    return {p,b};
  }

  let p3 = null, b3 = null;
  // Player third card rule
  if(pv<=5){
    p3 = deck.pop(); p.push(p3);
  }

  // Banker third card rule
  const bTotal = v=>mod10(v.reduce((a,c)=>a+cardValue(c.r),0));
  const lastP3Val = p3 ? cardValue(p3.r) : null;

  let bt = bTotal(b);
  if(!p3){
    if(bt<=5){ b3=deck.pop(); b.push(b3); }
  }else{
    // Banker draw rules when player draws third card
    if(bt<=2){ b3=deck.pop(); b.push(b3); }
    else if(bt===3 && lastP3Val!==8){ b3=deck.pop(); b.push(b3); }
    else if(bt===4 && (lastP3Val>=2 && lastP3Val<=7)){ b3=deck.pop(); b.push(b3); }
    else if(bt===5 && (lastP3Val>=4 && lastP3Val<=7)){ b3=deck.pop(); b.push(b3); }
    else if(bt===6 && (lastP3Val===6 || lastP3Val===7)){ b3=deck.pop(); b.push(b3); }
    // bt===7 stand
  }

  return {p,b};
}

function winnerOf(hands){
  const val = arr => mod10(arr.reduce((a,c)=>a+cardValue(c.r),0));
  const pv = val(hands.p), bv = val(hands.b);
  if(pv>bv) return 'player';
  if(bv>pv) return 'banker';
  return 'tie';
}

/* 動畫揭牌流程（5秒內跑完） */
async function revealFlow(){
  const deck = buildDeck();
  resetPiles();

  const hands = drawBaccarat(deck);

  // 建牌 DOM（背面朝上）
  const seq = [
    {who:'p', c:hands.p[0]},
    {who:'b', c:hands.b[0]},
    {who:'p', c:hands.p[1]},
    {who:'b', c:hands.b[1]},
  ];
  if(hands.p[2]) seq.push({who:'p', c:hands.p[2]});
  if(hands.b[2]) seq.push({who:'b', c:hands.b[2]});

  const cardEls=[];
  for(const step of seq){
    const el=createCardEl(step.c);
    (step.who==='p'?pileP:pileB).appendChild(el);
    cardEls.push(el);
  }

  // 逐張翻（間隔集中在 4 秒內）
  const gap = Math.max(120, Math.floor(3800 / cardEls.length));
  for(let i=0;i<cardEls.length;i++){
    await flip(cardEls[i], i===0?120:gap);
  }

  const result = winnerOf(hands);
  elResult.textContent = result==='banker'?'莊勝':result==='player'?'閒勝':'和局';
  return result;
}

/* ---------- 結算 ---------- */
function settle(result){
  let gain=0;
  if(result==='banker'){
    gain += bets.banker + Math.floor(bets.banker * PAY.banker);
    // player lost; tie lost
  }else if(result==='player'){
    gain += bets.player + Math.floor(bets.player * PAY.player);
  }else{ // tie
    gain += bets.tie + Math.floor(bets.tie * PAY.tie);
    gain += bets.banker + bets.player; // 退回
  }
  balance += gain; updateBalance();
  const diff = gain - 0;
  setMsg(`結果：${result==='banker'?'莊':result==='player'?'閒':'和'}，本局結算 +${fmt(diff)}`, true);

  history.push(result); renderRoad();
  clearBets();
}

/* ---------- 計時器 & 回合 ---------- */
function tick(){
  sec--; elTimer.textContent = sec;
  if(sec===REVEAL_SEC && phase==='bet'){
    setPhase('reveal');
    // 立即進入揭牌動畫
    revealFlow().then(res=>{
      // 動畫會在 4 秒內結束，剩餘時間交給倒數
      tableEl.dataset.lastResult = res;
    });
  }
  if(sec<=0){
    // 結算
    const res = tableEl.dataset.lastResult || 'tie';
    settle(res);
    startRound();
  }
}
function startRound(){
  sec = ROUND_SEC; elTimer.textContent = sec;
  setPhase('bet'); setMsg('請下注…'); elResult.textContent='等待中…';
  resetPiles();
}
function startLoop(){
  if(timerId) clearInterval(timerId);
  startRound(); timerId = setInterval(tick, 1000);
}

/* ---------- 初始化 ---------- */
function init(){
  updateBalance(); updateBets(); buildChips(); renderRoad(); startLoop();
}
init();
</script>
</body>
</html>
