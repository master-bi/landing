<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>行動百家樂 v3.4（正規大路＋橫向補牌＋自動捲動路單）</title>
<style>
  :root{
    --bg:#0f1320; --panel:#12182a; --panel2:#0b1223; --bar:#0d1220;
    --text:#e9f3ff; --muted:#8aa1c5; --ok:#22c55e; --warn:#facc15; --settle:#38bdf8;
    --player:#1fa2ff; --banker:#ff2257; --tie:#59d37a;
    --eyeR:#ff6d6d; --eyeB:#5fb0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC",sans-serif}
  body{margin:0;display:flex;justify-content:center}
  .phone{width:min(430px,100vw);height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,#0f1525,#0a0f1b 55%,#0b1020)}

  /* 牌桌＋倒數 */
  .video{position:relative;aspect-ratio:16/9;background:radial-gradient(60% 100% at 50% 0%, #202742 0%, #0d1222 65%);border-bottom:1px solid rgba(255,255,255,.06);overflow:hidden}
  .dealer{position:absolute;inset:0;background:
    linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,.25) 60%,rgba(0,0,0,.55)),
    radial-gradient(80% 120% at 50% -20%,rgba(255,255,255,.08),transparent 60%);}
  .countWrap{position:absolute;left:10px;top:10px;width:72px;height:72px;border-radius:50%;display:grid;place-items:center;z-index:3}
  .ring{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(#0000 56%,#000 57%);mask:radial-gradient(#0000 56%,#000 57%);box-shadow:0 0 0 3px rgba(255,255,255,.12) inset,0 4px 16px rgba(0,0,0,.4)}
  .num{position:relative;font-weight:900;font-size:26px;color:#111;text-shadow:0 1px 0 rgba(255,255,255,.5)}
  .phase{position:absolute;right:10px;top:10px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}

  /* 翻牌層＋標籤：標籤更靠中間 */
  .reveal{position:absolute;inset:0;display:none;pointer-events:none}
  .cards{position:absolute;top:58%;display:flex;gap:8px}
  .cards.player{left:22%}
  .cards.banker{right:22%}
  .label{position:absolute;top:14%;font-weight:900;font-size:14px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);z-index:2}
  .label.player{left:26%;color:var(--player)}
  .label.banker{right:26%;color:var(--banker)}

  .result-badge{position:absolute;left:50%;top:8px;transform:translateX(-50%);display:none;gap:10px;align-items:center;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);padding:4px 10px;border-radius:9px;font-weight:900;letter-spacing:1px}
  .rb-p{color:var(--player)} .rb-b{color:var(--banker)} .rb-t{color:var(--tie)}
  .rb-s{font-weight:900;padding:0 6px;border-radius:6px;background:rgba(255,255,255,.08)}

  .card{width:54px;height:74px;border-radius:8px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.6);transform-style:preserve-3d;transform:rotateY(180deg);transition:transform .45s ease}
  .card .face,.card .back{position:absolute;inset:0;border-radius:8px;backface-visibility:hidden;display:grid;place-items:center;font-size:20px;font-weight:800}
  .card .back{background:repeating-linear-gradient(45deg,#1c3a63 0 10px,#275389 10px 20px);transform:rotateY(180deg)}
  .card .face{color:#111}
  .card.flip{transform:rotateY(0)}

  .status{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bar);border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}

  /* 下注區 */
  .bet-grid{background:var(--panel);padding:6px;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;border-bottom:1px solid rgba(255,255,255,.06)}
  .tile{position:relative;border-radius:10px;padding:8px 6px 10px;text-align:center;background:linear-gradient(180deg,#121a33,#0e1428);border:1px solid rgba(255,255,255,.08);box-shadow:0 6px 14px rgba(0,0,0,.25) inset;user-select:none;cursor:pointer}
  .tile .name{font-size:16px;font-weight:800;letter-spacing:2px}
  .tile .odd{margin-top:1px;font-size:11px;color:var(--muted)}
  .player{outline:2px solid rgba(31,162,255,.25)} .banker{outline:2px solid rgba(255,34,87,.25)} .tie{outline:2px solid rgba(89,211,122,.25)}
  .pair{outline:2px dashed rgba(255,255,255,.25)} .super6{outline:2px dashed rgba(250,204,21,.45)}
  .lock{pointer-events:none;opacity:.5;filter:grayscale(1)}
  .winshine{position:absolute;inset:0;border-radius:10px;box-shadow:0 0 0 2px #fff inset;animation:shine .8s ease-out both}
  @keyframes shine{from{box-shadow:0 0 0 2px rgba(255,255,255,.0) inset}to{box-shadow:0 0 0 3px rgba(255,255,255,.8) inset}}

  /* 路單 */
  .roads{flex:1;display:grid;grid-template-rows:62% 38%;gap:6px;padding:8px;background:linear-gradient(180deg,#0b1223,#0a1020)}
  .topRoads{display:grid;grid-template-columns:1.3fr .9fr .9fr .9fr;gap:6px}
  .grid{width:100%;height:100%;display:grid;background:#0b1120;border:1px solid rgba(255,255,255,.08)}
  .bead{grid-template-columns:repeat(30,1fr);grid-auto-rows:calc((100%)/6)}
  .big{grid-template-columns:repeat(60,1fr);grid-auto-rows:calc((100%)/6)}
  .pairGrid{grid-template-columns:repeat(30,1fr);grid-auto-rows:calc((100%)/6)}
  .cell{border-right:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);display:grid;place-items:center;position:relative}

  /* 珠盤/大路 顏色：閒=藍、莊=紅、和=綠 */
  .dot{width:16px;height:16px;border-radius:50%}
  .dot.p{background:#1fa2ff}
  .dot.b{background:#ff2257}
  .dot.t{background:#59d37a}

  /* 和局：上一顆畫綠色斜線 */
  .tie-slash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .tie-slash::before{content:"";width:85%;height:2px;background:var(--tie);transform:rotate(45deg);box-shadow:0 0 0 1px rgba(0,0,0,.15)}

  /* 三路（米字紋紅/藍） */
  .stamp{width:14px;height:14px;border-radius:3px;position:relative}
  .stamp.red{
    background:
      repeating-linear-gradient(45deg, rgba(255,255,255,0) 0 3px, rgba(255,255,255,0) 3px 6px),
      repeating-linear-gradient(45deg, #ff6d6d 0 2px, transparent 2px 6px),
      repeating-linear-gradient(135deg, #ff6d6d 0 2px, transparent 2px 6px);
    box-shadow:0 0 0 1px rgba(255,255,255,.18) inset;
  }
  .stamp.blue{
    background:
      repeating-linear-gradient(45deg, rgba(255,255,255,0) 0 3px, rgba(255,255,255,0) 3px 6px),
      repeating-linear-gradient(45deg, #5fb0ff 0 2px, transparent 2px 6px),
      repeating-linear-gradient(135deg, #5fb0ff 0 2px, transparent 2px 6px);
    box-shadow:0 0 0 1px rgba(255,255,255,.18) inset;
  }

  /* 籌碼＋動作 */
  .chips{padding:8px 6px;display:flex;gap:8px;justify-content:center;background:var(--panel2);border-top:1px solid rgba(255,255,255,.06)}
  .chip{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:900;cursor:pointer;background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.85), rgba(255,255,255,.65) 60%, rgba(255,255,255,.3) 61%),conic-gradient(from 0turn,#fff0 0 22%,#fff 0 25%,#fff0 0 47%,#fff 0 50%,#fff0 0 72%,#fff 0 75%,#fff0 0);box-shadow:0 6px 14px rgba(0,0,0,.35);color:#101421;border:5px solid #2aa1ff;font-size:11px}
  .chip[data-v="500"]{border-color:#8c9eff}.chip[data-v="1000"]{border-color:#00e8ff}.chip[data-v="5000"]{border-color:#ffaa00}.chip[data-v="10000"]{border-color:#7dff9a}.chip[data-v="50000"]{border-color:#32c5ff}.chip[data-v="100000"]{border-color:#ff6a6a}
  .actions{display:flex;gap:8px;justify-content:center;padding:8px;background:var(--panel2);border-top:1px solid rgba(255,255,255,.06)}
  .btn{padding:10px 14px;border-radius:10px;font-weight:800;letter-spacing:.5px}
  .btn-ghost{background:#10182a;border:1px solid rgba(255,255,255,.15);color:var(--muted)}
  .btn-ok{background:linear-gradient(180deg,#10b981,#059669);border:1px solid rgba(255,255,255,.12)}
  .tip{padding:6px 10px;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="phone">
  <div class="video">
    <div class="dealer"></div>
    <div class="countWrap"><div class="ring" id="ring"></div><div class="num" id="cd">15</div></div>
    <div class="phase" id="phase">下注中</div>
    <div class="result-badge" id="rb"><span class="rb-p" id="rbp">P 0</span><span class="rb-s">:</span><span class="rb-b" id="rbb">B 0</span><span class="rb-t" id="rbt" style="display:none;">TIE</span></div>
    <div class="label player">閒</div>
    <div class="label banker">莊</div>
    <div class="reveal" id="reveal">
      <div class="cards player" id="pcards"></div>
      <div class="cards banker" id="bcards"></div>
    </div>
  </div>

  <div class="status">餘額：<span id="bal">100000</span></div>

  <div class="bet-grid" id="betGrid">
    <div class="tile pair" data-bet="ppair"><div class="name">閒對</div><div class="odd">1 : 11</div></div>
    <div class="tile super6" data-bet="super6"><div class="name">超級六</div><div class="odd">2張6→12:1；3張6→20:1</div></div>
    <div class="tile pair" data-bet="bpair"><div class="name">莊對</div><div class="odd">1 : 11</div></div>
    <div class="tile player" data-bet="player"><div class="name">閒</div><div class="odd">1 : 1</div></div>
    <div class="tile tie" data-bet="tie"><div class="name">和</div><div class="odd">1 : 8</div></div>
    <div class="tile banker" data-bet="banker"><div class="name">莊</div><div class="odd">返 1.95</div></div>
  </div>

  <div class="roads">
    <div class="topRoads">
      <div class="grid big" id="big"></div>
      <div class="grid pairGrid" id="bigeye"></div>
      <div class="grid pairGrid" id="smallroad"></div>
      <div class="grid pairGrid" id="roach"></div>
    </div>
    <div class="grid bead" id="bead"></div>
  </div>

  <div class="chips" id="chips">
    <div class="chip" data-v="100">100</div><div class="chip" data-v="500">500</div><div class="chip" data-v="1000">1K</div>
    <div class="chip" data-v="5000">5K</div><div class="chip" data-v="10000">10K</div><div class="chip" data-v="50000">50K</div><div class="chip" data-v="100000">100K</div>
  </div>
  <div class="actions"><button class="btn btn-ghost" id="cancel">取消下注</button><button class="btn btn-ok" id="confirm">確認下注</button></div>
  <div class="tip" id="tip">選籌碼 → 點下注區；下注期內可多次「確認下注」（限紅 100~100000）。</div>
</div>

<script>
/* ===== 參數 ===== */
const LIMIT_MIN=100, LIMIT_MAX=100000;
const CHIPS=[100,500,1000,5000,10000,50000,100000];
const PHASES={ BETTING:{key:'BETTING',label:'下注中',sec:15}, REVEAL:{key:'REVEAL',label:'開牌中',sec:5}, SETTLE:{key:'SETTLE',label:'結算中',sec:5} };
let phase=PHASES.BETTING, secLeft=phase.sec, timer=null;
let balance=100000, choChip=CHIPS[0];

/* 注單 */
const pending={player:0,banker:0,tie:0,ppair:0,bpair:0,super6:0};
const placed ={player:0,banker:0,tie:0,ppair:0,bpair:0,super6:0};

/* DOM */
const $=s=>document.querySelector(s);
const ring=$('#ring'), cd=$('#cd'), phaseEl=$('#phase'), balEl=$('#bal'), tipEl=$('#tip');
const betGrid=$('#betGrid'), chips=$('#chips');
const revealLayer=$('#reveal'), pWrap=$('#pcards'), bWrap=$('#bcards');
const rb=$('#rb'), rbp=$('#rbp'), rbb=$('#rbb'), rbt=$('#rbt');
const beadEl=$('#bead'), bigEl=$('#big'), eyeEl=$('#bigeye'), smallEl=$('#smallroad'), roachEl=$('#roach');

/* ===== 路格建置 ===== */
const ROWS=6, COLS_BEAD=30, COLS_BIG=60, COLS_PAIR=30;
function initGrid(container, cols){
  container.innerHTML='';
  for(let c=0;c<cols;c++){ appendEmptyColumn(container); }
}
function appendEmptyColumn(container){
  for(let r=0;r<ROWS;r++){ const cell=document.createElement('div'); cell.className='cell'; container.appendChild(cell); }
}
function shiftGridLeft(container){
  // 移除最左一欄（前6個 cell），尾端補一欄
  for(let i=0;i<ROWS;i++) container.removeChild(container.firstElementChild);
  appendEmptyColumn(container);
}
initGrid(beadEl, COLS_BEAD);
initGrid(bigEl, COLS_BIG);
initGrid(eyeEl, COLS_PAIR);
initGrid(smallEl, COLS_PAIR);
initGrid(roachEl, COLS_PAIR);
function cellEl(container,c,r){ return container.children[c*ROWS+r]||null }
function clearColumn(container,c){ for(let r=0;r<ROWS;r++){ const el=cellEl(container,c,r); if(el) el.innerHTML=''; } }

/* ===== 珠盤（上→下，滿6換欄；滿寬時左捲） ===== */
let beadCol=0, beadRow=0;
function drawBead(mark){
  if(beadCol>=COLS_BEAD){ // 安全保護
    beadCol=COLS_BEAD-1; beadRow=ROWS-1;
  }
  let el=cellEl(beadEl, beadCol, beadRow);
  if(!el){
    // 已滿寬 → 左捲一欄
    shiftGridLeft(beadEl);
    beadCol=COLS_BEAD-1; beadRow=0;
    el=cellEl(beadEl, beadCol, beadRow);
  }
  const d=document.createElement('div'); d.className=`dot ${mark}`; el.appendChild(d);
  beadRow++;
  if(beadRow>=ROWS){ beadRow=0; beadCol++; }
  if(beadCol>=COLS_BEAD){ // 加完這顆後若超寬，下一次會觸發左捲
    shiftGridLeft(beadEl);
    beadCol=COLS_BEAD-1; beadRow=0;
  }
}

/* ===== 大路資料（同下異右；和不前進畫斜線；滿寬左捲） ===== */
const bigData=[...Array(COLS_BIG)].map(()=>Array(ROWS).fill(null));
let bigCol=0,bigRow=0,lastMain=null; // 'p'|'b'
const bigSeq=[]; // {c,r,side}

/* 畫三路用：同步左捲（只做容器左捲＋游標修正） */
let eyeC=0,eyeR=0, smallC=0,smallR=0, roachC=0,roachR=0;
function shiftAllRoadsLeft(){
  shiftGridLeft(bigEl);
  shiftGridLeft(eyeEl);
  shiftGridLeft(smallEl);
  shiftGridLeft(roachEl);
  // 資料左捲
  bigData.splice(0,1); bigData.push(Array(ROWS).fill(null));
  // 游標左移
  bigCol=Math.max(0,bigCol-1);
  eyeC=Math.max(0,eyeC-1); smallC=Math.max(0,smallC-1); roachC=Math.max(0,roachC-1);
  // 序列 c--，負值丟掉
  for(let i=0;i<bigSeq.length;i++){ bigSeq[i].c--; }
  while(bigSeq.length && bigSeq[0].c<0) bigSeq.shift();
}

function drawBig(mark){
  // tie：在當前最後一顆上畫綠斜線，不前進
  if(mark==='t'){
    const el = cellEl(bigEl,bigCol,bigRow) || cellEl(bigEl,0,0);
    if(el){ const s=document.createElement('div'); s.className='tie-slash'; el.appendChild(s); }
    bigSeq.push({c:Math.max(bigCol,0), r:Math.max(bigRow,0), side:'t'});
    return;
  }

  if(lastMain===null){
    bigCol=0; bigRow=0; lastMain=mark;
  }else if(mark===lastMain){
    // 同邊 → 往下；若被阻塞（到底或下方有子）則往右
    if(bigRow<ROWS-1 && !bigData[bigCol][bigRow+1]){
      bigRow++;
    }else{
      bigCol++;
    }
  }else{
    // 換邊 → 開新列（往右，從最上）；若被占，持續往右找空列
    lastMain=mark; bigCol++; bigRow=0;
    while(bigData[bigCol] && bigData[bigCol][bigRow]) bigCol++;
  }

  // 超寬 → 左捲
  if(bigCol>=COLS_BIG){
    shiftAllRoadsLeft();
  }

  // 設置顏色點
  bigData[bigCol][bigRow]=mark;
  const el=cellEl(bigEl,bigCol,bigRow);
  if(el){ const d=document.createElement('div'); d.className=`dot ${mark}`; el.appendChild(d); }
  bigSeq.push({c:bigCol,r:bigRow,side:mark});
  deriveAndDraw();
}

/* ===== 衍生路（依澳門規則；配合左捲） ===== */
function colDepth(col){ if(col<0) return 0; let n=0; for(let r=0;r<ROWS;r++){ if(bigData[col] && bigData[col][r]) n++; else break; } return n; }
function filled(col,row){ return !!(bigData[col] && bigData[col][row]); }
function pushDerived(cont, which, color){
  let C = which==='eye'?eyeC: which==='small'?smallC: roachC;
  let R = which==='eye'?eyeR: which==='small'?smallR: roachR;
  if(R<ROWS-1 && !cellEl(cont,C,R+1).hasChildNodes()){ R++; }
  else{ C++; R=0; clearColumn(cont,C); }
  // 超寬 → 左捲
  const maxCols = (cont===bigEl)?COLS_BIG:COLS_PAIR;
  if(C>=maxCols){
    shiftGridLeft(cont);
    C=maxCols-1; R=0;
  }
  const el=cellEl(cont,C,R), dot=document.createElement('div');
  dot.className=`stamp ${color==='red'?'red':'blue'}`; el.appendChild(dot);
  if(which==='eye'){eyeC=C;eyeR=R}else if(which==='small'){smallC=C;smallR=R}else{roachC=C;roachR=R}
}
function deriveAndDraw(){
  const last = bigSeq[bigSeq.length-1]; if(!last) return; const {c,r}=last;
  if(last.side==='t') return; // 和局不產生三路點
  if(c>=1){ const color = (r===0) ? ((colDepth(c-1)===colDepth(c-2))?'red':'blue') : (filled(c-1,r-1)?'red':'blue'); pushDerived(eyeEl,'eye',color); }
  if(c>=2){ const color = (r===0) ? ((colDepth(c-1)===colDepth(c-3))?'red':'blue') : (filled(c-2,r-1)?'red':'blue'); pushDerived(smallEl,'small',color); }
  if(c>=3){ const color = (r===0) ? ((colDepth(c-1)===colDepth(c-4))?'red':'blue') : (filled(c-3,r-1)?'red':'blue'); pushDerived(roachEl,'roach',color); }
}

/* ===== 倒數圈 ===== */
function setRing(rate){
  const deg=Math.max(0,Math.min(1,rate))*360;
  const col=phase===PHASES.BETTING?'var(--ok)':(phase===PHASES.REVEAL?'var(--warn)':'var(--settle)');
  ring.style.background=`conic-gradient(${col} 0 ${deg}deg, rgba(255,255,255,.12) ${deg}deg 360deg)`;
}
function startClock(){
  clearInterval(timer); secLeft=phase.sec; phaseEl.textContent=phase.label;
  setRing(1); cd.textContent=secLeft;
  timer=setInterval(()=>{secLeft--; cd.textContent=secLeft; setRing(secLeft/phase.sec); if(secLeft<=0){clearInterval(timer); nextPhase();}},1000);
}
function lockBets(lock){ betGrid.querySelectorAll('.tile').forEach(t=>t.classList.toggle('lock',lock)) }

/* ===== 洗牌與牌值 ===== */
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const SUITS=['♠','♥','♣','♦'];
function buildShoe(decks=8){const s=[];for(let d=0;d<decks;d++){for(const r of RANKS){for(const t of SUITS){s.push({r,s:t})}}}shuffle(s);return s}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
let shoe=buildShoe(8);
function draw(){ if(shoe.length<0.25*52*8){ shoe=buildShoe(8); tip('新鞋已洗好'); } return shoe.pop() }
function val(r){ return r==='A'?1 : (r==='10'||r==='J'||r==='Q'||r==='K'?0:parseInt(r,10));}
function totalPts(cs){return cs.reduce((a,c)=>(a+val(c.r))%10,0)}
function face(c){return `${c.r}${c.s}`}

/* ===== 橫向補牌動畫（閒補左、莊補右） ===== */
function createCard(txt){ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="back"></div><div class="face">${escapeHtml(txt)}</div>`; return el; }
async function addCard(wrap, card, where='append'){
  return new Promise(res=>{
    const el=createCard(face(card));
    if(where==='prepend' && wrap.firstChild) wrap.insertBefore(el, wrap.firstChild);
    else wrap.appendChild(el);
    setTimeout(()=>el.classList.add('flip'),160);
    setTimeout(res, 800);
  });
}
async function dealRoundAnimated(){
  const p=[draw(),draw()], b=[draw(),draw()];
  let pt=totalPts(p), bt=totalPts(b);
  let pThird=null, bThird=null;

  revealLayer.style.display='block';
  pWrap.innerHTML=''; bWrap.innerHTML='';

  await addCard(pWrap,p[0],'append'); await addCard(pWrap,p[1],'append');
  await addCard(bWrap,b[0],'append'); await addCard(bWrap,b[1],'append');

  pt=totalPts(p); bt=totalPts(b);
  const natural=(pt>=8 || bt>=8);

  if(!natural){
    if(pt<=5){ pThird=draw(); p.push(pThird); pt=totalPts(p); await addCard(pWrap,pThird,'prepend'); } // 閒補左邊
    if(pThird===null){
      if(bt<=5){ bThird=draw(); b.push(bThird); bt=totalPts(b); await addCard(bWrap,bThird,'append'); } // 莊補右邊
    }else{
      const t=val(pThird.r);
      let needB=false;
      if(bt<=2) needB=true;
      else if(bt===3 && t!==8) needB=true;
      else if(bt===4 && (t>=2 && t<=7)) needB=true;
      else if(bt===5 && (t>=4 && t<=7)) needB=true;
      else if(bt===6 && (t===6||t===7)) needB=true;
      if(needB){ bThird=draw(); b.push(bThird); bt=totalPts(b); await addCard(bWrap,bThird,'append'); } // 莊補右邊
    }
  }

  rb.style.display='flex'; rbt.style.display='none';
  rbp.textContent=`P ${pt}`; rbb.textContent=`B ${bt}`; if(pt===bt){ rbt.style.display='inline'; }

  const ppair=(p[0].r===p[1].r), bpair=(b[0].r===b[1].r);
  const winner = pt>bt?'player': bt>pt?'banker':'tie';
  return {pCards:p,bCards:b,pTotal:pt,bTotal:bt,winner,ppair,bpair};
}

/* ===== 派彩 ===== */
function payout(info, bet){
  let win=0;
  if(info.winner==='player') win += bet.player*2;
  if(info.winner==='banker') win += Math.floor(bet.banker*1.95);
  if(info.winner==='tie'){ win += bet.tie*9; win += (bet.player+bet.banker); }
  if(info.ppair) win += bet.ppair*12;
  if(info.bpair) win += bet.bpair*12;
  if(info.winner==='banker' && info.bTotal===6){
    win += (info.bCards.length===3 ? bet.super6*21 : bet.super6*13);
  }
  return win;
}

/* ===== 階段（封盤 1s、自動清 pending、倒數接關） ===== */
async function nextPhase(){
  try{
    if(phase===PHASES.BETTING){
      for(const k in pending) pending[k]=0; showPending(); lockBets(true);
      phaseEl.textContent='封盤中…'; setRing(1); cd.textContent=''; await new Promise(r=>setTimeout(r,1000));

      phase=PHASES.REVEAL; startClock();
      const info = await dealRoundAnimated();

      const beadMark = info.winner==='player'?'p':info.winner==='banker'?'b':'t';
      drawBead(beadMark);
      drawBig(beadMark);

      const winAmt = payout(info, placed);
      balance += winAmt; balEl.textContent = fmt(balance);
      tip(`結果：${info.winner==='player'?'閒':info.winner==='banker'?'莊':'和'}　派彩 +${fmt(winAmt)}`);
      return;
    }
    if(phase===PHASES.REVEAL){ phase=PHASES.SETTLE; startClock(); return; }
    if(phase===PHASES.SETTLE){
      for(const k in placed) placed[k]=0;
      lockBets(false); revealLayer.style.display='none'; rb.style.display='none';
      tip('新一局開始（可多次確認加注；限紅 100~100000）'); phase=PHASES.BETTING; startClock(); return;
    }
  }catch(err){
    console.error('nextPhase error:', err);
    tip('系統已自動重開新局'); for(const k in pending) pending[k]=0; for(const k in placed) placed[k]=0;
    revealLayer.style.display='none'; rb.style.display='none'; lockBets(false); phase=PHASES.BETTING; startClock();
  }
}

/* ===== 下注 ===== */
function total(obj){ return Object.values(obj).reduce((a,b)=>a+b,0) }
function available(){ return balance - total(placed) - total(pending) }
chips.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>{choChip=+c.dataset.v; tip(`選擇籌碼 ${fmt(choChip)}`)}));
betGrid.querySelectorAll('.tile').forEach(t=>{
  t.addEventListener('click',()=>{
    if(phase!==PHASES.BETTING) return;
    const k=t.dataset.bet, av=available();
    if(choChip>av){ tip('可用餘額不足'); return; }
    const newSum = placed[k] + pending[k] + choChip;
    if(newSum>LIMIT_MAX){ tip('超過限紅 100000'); return; }
    pending[k]+=choChip; showPending(); flash(t);
  });
});
$('#cancel').addEventListener('click',()=>{ for(const k in pending) pending[k]=0; showPending(); tip('已取消未確認的注單'); });
$('#confirm').addEventListener('click',()=>{
  if(phase!==PHASES.BETTING){ tip('已停止下注'); return; }
  const pendTotal=total(pending); if(pendTotal===0){ tip('尚未選擇任何注項'); return; }
  for(const k in pending){
    const sum=placed[k]+pending[k];
    if(sum>0 && sum<LIMIT_MIN){ tip('每門至少 100'); return; }
    if(sum>LIMIT_MAX){ tip('超過限紅 100000'); return; }
  }
  balance -= pendTotal; balEl.textContent=fmt(balance);
  for(const k in pending){ placed[k]+=pending[k]; pending[k]=0; }
  showPending(); tip('已確認下注（可繼續加注直至封盤）');
});
function showPending(){
  betGrid.querySelectorAll('.tile').forEach(t=>{
    const k=t.dataset.bet, p=pending[k], b=placed[k], odd=t.querySelector('.odd');
    let base=(k==='player')?'1 : 1':(k==='banker')?'返 1.95':(k==='tie')?'1 : 8':(k==='ppair'||k==='bpair')?'1 : 11':'2張6→12:1；3張6→20:1';
    let extra=''; if(b) extra+=` | 已下 ${fmt(b)}`; if(p) extra+=` | 暫存 ${fmt(p)}`; odd.textContent=base+(extra?('　'+extra):'');
  });
}

/* ===== 小工具 ===== */
function fmt(n){ return n.toLocaleString('zh-Hant-TW'); }
function escapeHtml(s){ return s.replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }
function flash(el){ const s=document.createElement('div'); s.className='winshine'; el.appendChild(s); setTimeout(()=>s.remove(),320); }
function tip(t){ tipEl.textContent=t; }

/* ===== 啟動 ===== */
balEl.textContent=fmt(balance);
showPending();
startClock();
</script>
</body>
</html>
